# Финальный проект 1 семестра

REST API сервис для загрузки и выгрузки данных о ценах.

## Требования к системе

### Для локального запуска:
- **Go** версии 1.23.3 или выше
- **PostgreSQL** версии 15 или выше
- **Docker** и **Docker Compose** для контейнеризации

### Для развертывания через скрипт `run.sh`:
- **Yandex Cloud CLI** (yc) установленный и настроенный
- Доступ к Yandex Cloud с правами на создание виртуальных машин
- SSH ключи для доступа к создаваемым инстансам

### Минимальные требования к аппаратному обеспечению:
- 2 CPU ядра
- 2 GB RAM
- 10 GB свободного места на диске

## Установка и запуск

### Локальный запуск через Docker Compose

1. Клонируйте репозиторий:
```bash
git clone <repository-url>
cd itmo-devops-sem1-project-template
```

2. Создайте файл `.env` в корне проекта со следующим содержимым:
```env
POSTGRES_DB=prices_db
POSTGRES_USER=postgres
POSTGRES_PASSWORD=postgres
```

3. Запустите приложение и базу данных:
```bash
docker compose up -d --build
```

4. Приложение будет доступно по адресу: `http://localhost:8080`

5. Для остановки:
```bash
docker compose down
```

### Локальный запуск без Docker

1. Убедитесь, что PostgreSQL запущен и доступен

2. Установите зависимости:
```bash
go mod download
```

3. Установите переменную окружения:
```bash
export DATABASE_URL="postgres://postgres:postgres@localhost:5432/prices_db?sslmode=disable"
```

4. Запустите приложение:
```bash
go run main.go
```

### Развертывание на Yandex Cloud через скрипт

1. Убедитесь, что Yandex Cloud CLI настроен:
```bash
yc init
```

2. Установите переменные окружения (опционально):
```bash
export YC_FOLDER_ID="your-folder-id"
export YC_ZONE="ru-central1-a"
export POSTGRES_DB="prices_db"
export POSTGRES_USER="postgres"
export POSTGRES_PASSWORD="your-secure-password"
```

3. Запустите скрипт развертывания:
```bash
./scripts/run.sh
```

Скрипт автоматически:
- Создаст виртуальную машину в Yandex Cloud
- Установит Docker на удаленном сервере
- Скопирует файлы проекта
- Развернет приложение и базу данных через Docker Compose
- Вернет IP-адрес созданного сервера

### Сборка Docker образа

Для сборки Docker образа используйте скрипт:
```bash
./scripts/prepare.sh
```

Или вручную:
```bash
docker build -t prices-app:latest .
```

## Тестирование

Директория `sample_data` - это пример директории, которая является разархивированной версией файла `sample_data.zip`

### Запуск тестов

Приложение включает набор автоматических тестов, которые проверяют работу API на трех уровнях сложности:

#### Простой уровень (уровень 1)
Проверяет базовую функциональность:
- POST запрос для загрузки данных из ZIP архива
- GET запрос для выгрузки данных
- Подключение к PostgreSQL и выполнение базовых запросов

Запуск:
```bash
./scripts/tests.sh 1
```

#### Продвинутый уровень (уровень 2)
Проверяет расширенную функциональность:
- POST запрос с поддержкой ZIP и TAR архивов
- Корректная обработка различных типов архивов
- Расширенные SQL запросы с агрегацией данных

Запуск:
```bash
./scripts/tests.sh 2
```

#### Сложный уровень (уровень 3)
Проверяет обработку некорректных данных и фильтрацию:
- Обработка некорректных данных (невалидные цены, даты, пустые поля)
- Обнаружение и подсчет дубликатов
- GET запрос с фильтрами (дата начала, дата окончания, минимальная и максимальная цена)
- Проверка корректности выгружаемых данных

Запуск:
```bash
./scripts/tests.sh 3
```

### Описание тестов

Тесты проверяют следующие аспекты работы API:

1. **POST /api/v0/prices**:
   - Загрузка ZIP/TAR архивов с CSV файлами
   - Парсинг и валидация данных
   - Обнаружение дубликатов
   - Сохранение данных в базу данных
   - Возврат статистики (total_count, duplicates_count, total_items, total_categories, total_price)

2. **GET /api/v0/prices**:
   - Выгрузка данных с опциональными фильтрами:
     - `start` - начальная дата (формат: YYYY-MM-DD)
     - `end` - конечная дата (формат: YYYY-MM-DD)
     - `min` - минимальная цена
     - `max` - максимальная цена
   - Возврат данных в виде ZIP архива с файлом `data.csv`

3. **Проверка базы данных**:
   - Подключение к PostgreSQL
   - Выполнение SQL запросов различной сложности
   - Проверка целостности данных

### Пример использования API

#### Загрузка данных:
```bash
curl -F "file=@sample_data.zip" http://localhost:8080/api/v0/prices
```

#### Выгрузка данных с фильтрами:
```bash
curl "http://localhost:8080/api/v0/prices?start=2024-01-01&end=2024-01-31&min=100&max=1000" -o output.zip
```

## Контакт

[t.me/tdkochtov](https://t.me/tdkochtov)
