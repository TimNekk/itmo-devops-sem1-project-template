name: Go Test Pipeline

on:
    push:
        branches: [main, master]
    pull_request:
        branches: [main, master]

jobs:
    test:
        name: Run Tests
        runs-on: ubuntu-latest

        services:
            postgres:
                image: postgres:15
                env:
                    POSTGRES_DB: project-sem-1
                    POSTGRES_USER: validator
                    POSTGRES_PASSWORD: val1dat0r
                ports:
                    - 5432:5432
                options: >-
                    --health-cmd pg_isready
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5

        steps:
            - uses: actions/checkout@v3

            - name: Build Docker image
              run: docker build -t prices-app:latest .

            - name: Run application container
              run: |
                  docker run -d \
                    --name prices-app \
                    --network host \
                    -e DATABASE_URL="postgres://validator:val1dat0r@localhost:5432/project-sem-1?sslmode=disable" \
                    prices-app:latest

                  # Wait for the application to start
                  echo "Waiting for application to start..."
                  sleep 5

                  # Check if container is running
                  if ! docker ps | grep -q prices-app; then
                    echo "Container failed to start. Logs:"
                    docker logs prices-app
                    exit 1
                  fi

                  # Wait for API to be ready
                  for i in {1..30}; do
                    if curl -s http://localhost:8080/api/v0/prices > /dev/null 2>&1; then
                      echo "Application is ready!"
                      break
                    fi
                    echo "Waiting for API... (attempt $i/30)"
                    sleep 2
                  done

            - name: Make test script executable
              run: chmod +x scripts/tests.sh

            - name: Test Level 1
              id: test-level-1
              continue-on-error: true
              run: ./scripts/tests.sh 1

            - name: Reset database for Level 2
              if: always()
              run: |
                  PGPASSWORD=val1dat0r psql -h localhost -U validator -d project-sem-1 -c "TRUNCATE TABLE prices;" 2>/dev/null || true

            - name: Test Level 2
              id: test-level-2
              continue-on-error: true
              run: ./scripts/tests.sh 2

            - name: Reset database for Level 3
              if: always()
              run: |
                  PGPASSWORD=val1dat0r psql -h localhost -U validator -d project-sem-1 -c "TRUNCATE TABLE prices;" 2>/dev/null || true

            - name: Test Level 3
              id: test-level-3
              continue-on-error: true
              run: ./scripts/tests.sh 3

            - name: Show application logs
              if: always()
              run: docker logs prices-app 2>&1 || true

            - name: Check test results
              if: always()
              run: |
                  if [[ "${{ steps.test-level-1.outcome }}" == "success" ]] || \
                     [[ "${{ steps.test-level-2.outcome }}" == "success" ]] || \
                     [[ "${{ steps.test-level-3.outcome }}" == "success" ]]; then
                    echo "At least one test level passed successfully!"
                    exit 0
                  else
                    echo "All test levels failed!"
                    exit 1
                  fi
